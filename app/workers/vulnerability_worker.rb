require 'open-uri'

class VulnerabilityWorker
  include Sidekiq::Worker

  def perform
    page = Nokogiri::HTML(open('https://rubysec.com/advisories'))
    page.css('tr').each do |tr|
      v = Vulnerability.new

      attributes = tr.css('td').map { |td| td.text.strip }

      v.date = attributes[0]
      v.rubygem = attributes[1]
      v.title = attributes[2]
      v.cve = attributes[3]

      unless v.save
        Rails.logger.error("VulnerabilityWorker: error while saving vulnerability - #{v.inspect}")
      end
    end
  end
end
